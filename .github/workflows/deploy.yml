name: Build and Deploy to Azure Container Apps

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read

env:
  RESOURCE_GROUP: rg-stakr-prod
  CONTAINER_APP_NAME: stakr-backend
  CONTAINER_ENV: env-stakr
  IMAGE_NAME: stakr-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get semantic version
        id: version
        run: |
          if git describe --tags --exact-match 2>/dev/null; then
            VERSION=$(git describe --tags --exact-match | sed 's/^v//')
          else
            VERSION=$(grep -oP '(?<=APP_VERSION = ")[^"]+' backend/app/core/version.py)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.AZURE_CONTAINER_REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ secrets.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy (migrate then update)
        shell: bash
        run: |
          set -euo pipefail

          IMAGE="${{ secrets.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Image: ${IMAGE}"

          az version

          # Container Apps CLI extension (preview required)
          az extension add --name containerapp --version 0.3.53 --upgrade --yes

          # Ensure the Container App exists (create once)
          if ! az containerapp show --name "${{ env.CONTAINER_APP_NAME }}" --resource-group "${{ env.RESOURCE_GROUP }}" --only-show-errors 1>/dev/null; then
            az containerapp create \
              --name "${{ env.CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --environment "${{ env.CONTAINER_ENV }}" \
              --image "${IMAGE}" \
              --registry-server "${{ secrets.AZURE_CONTAINER_REGISTRY }}" \
              --registry-username "${{ secrets.REGISTRY_USERNAME }}" \
              --registry-password "${{ secrets.REGISTRY_PASSWORD }}" \
              --ingress external \
              --target-port 8000 \
              --min-replicas 1 \
              --only-show-errors
          fi

          # We'll scale to 0 when we're done (off-traffic), but we need at least 1 replica for exec.
          DESIRED_MIN_REPLICAS_AFTER_DEPLOY=0

          # --- Migrations ---
          echo "Ensuring at least one running replica for migrations..."
          az containerapp update \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --min-replicas 1 \
            --image "${IMAGE}" \
            --only-show-errors

          echo "Waiting for the app to be ready and have a ready revision..."
          READY_REVISION=""
          for i in {1..60}; do
            READY_REVISION=$(az containerapp show \
              --name "${{ env.CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query "properties.latestReadyRevisionName" \
              -o tsv 2>/dev/null || true)

            RUNNING_STATUS=$(az containerapp show \
              --name "${{ env.CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query "properties.runningStatus" \
              -o tsv 2>/dev/null || true)

            if [ -n "${READY_REVISION}" ] && [ "${READY_REVISION}" != "null" ] && [ "${RUNNING_STATUS}" = "Running" ]; then
              echo "App is running. latestReadyRevisionName=${READY_REVISION}"
              break
            fi

            echo "Not ready yet (${i}/60). runningStatus=${RUNNING_STATUS:-?} latestReadyRevisionName=${READY_REVISION:-?}. Sleeping 5s..."
            sleep 5
          done

          if [ -z "${READY_REVISION}" ] || [ "${READY_REVISION}" = "null" ]; then
            echo "ERROR: No ready revision found after waiting."
            az containerapp show --name "${{ env.CONTAINER_APP_NAME }}" --resource-group "${{ env.RESOURCE_GROUP }}" -o json || true
            exit 3
          fi

          echo "Waiting for at least one Running replica (healthState is not reliable on all CLI versions)..."
          REPLICA_NAME=""
          for i in {1..60}; do
            REPLICA_NAME=$(az containerapp replica list \
              --name "${{ env.CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query "[?properties.runningState=='Running'] | [0].name" \
              -o tsv 2>/dev/null || true)

            if [ -n "${REPLICA_NAME}" ] && [ "${REPLICA_NAME}" != "null" ]; then
              echo "Found running replica: ${REPLICA_NAME}"
              break
            fi

            echo "No running replica yet (${i}/60). Sleeping 5s..."
            sleep 5
          done

          if [ -z "${REPLICA_NAME}" ] || [ "${REPLICA_NAME}" = "null" ]; then
            echo "ERROR: No running replica found after waiting."
            az containerapp replica list --name "${{ env.CONTAINER_APP_NAME }}" --resource-group "${{ env.RESOURCE_GROUP }}" -o table || true
            exit 3
          fi

          echo "Running Alembic migrations (in-app exec). latestReadyRevisionName=${READY_REVISION} replica=${REPLICA_NAME}"
          # `az containerapp exec` may require a TTY.
          script -q -e -c "az containerapp exec --name '${{ env.CONTAINER_APP_NAME }}' --resource-group '${{ env.RESOURCE_GROUP }}' --command 'python -m alembic upgrade head' --only-show-errors" /dev/null

          # --- Deploy app ---
          az containerapp update \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --image "${IMAGE}" \
            --only-show-errors

          FQDN=$(az containerapp show \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "Deployed: https://${FQDN}"

          # Scale to 0 off-traffic (as requested)
          echo "Scaling to minReplicas=${DESIRED_MIN_REPLICAS_AFTER_DEPLOY} (off-traffic)..."
          az containerapp update \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --min-replicas ${DESIRED_MIN_REPLICAS_AFTER_DEPLOY} \
            --only-show-errors

      - name: Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
