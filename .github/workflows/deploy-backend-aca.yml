name: Deploy backend to Azure Container Apps

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  RESOURCE_GROUP: rg-stakr-prod
  CONTAINER_APP_NAME: stakr-backend
  CONTAINER_ENV: env-stakr

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy latest backend image
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${{ secrets.AZURE_CONTAINER_REGISTRY }}" ]]; then
            echo "Missing secret: AZURE_CONTAINER_REGISTRY (example: stakrregistry.azurecr.io)"
            exit 1
          fi

          IMAGE="${{ secrets.AZURE_CONTAINER_REGISTRY }}/stakr-backend:latest"
          echo "Deploying image: ${IMAGE}"

          az extension add --name containerapp --upgrade --yes

          # Ensure the Container App knows how to pull from the private registry
          az containerapp registry set \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --server "${{ secrets.AZURE_CONTAINER_REGISTRY }}" \
            --username "${{ secrets.REGISTRY_USERNAME }}" \
            --password "${{ secrets.REGISTRY_PASSWORD }}" \
            --only-show-errors

          az containerapp update \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --image "${IMAGE}" \
            --only-show-errors

      - name: Summary
        if: always()
        run: |
          echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** `${{ secrets.AZURE_CONTAINER_REGISTRY }}/stakr-backend:latest`" >> $GITHUB_STEP_SUMMARY
