name: Deploy backend to Azure Container Apps

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  RESOURCE_GROUP: rg-stakr-prod
  CONTAINER_APP_NAME: stakr-backend
  CONTAINER_ENV: env-stakr

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy latest backend image
        shell: bash
        run: |
          set -euo pipefail

          IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/stakr-backend:latest"
          echo "Deploying image: ${IMAGE}"

          az extension add --name containerapp --upgrade --yes

          az containerapp update \
            --name "${{ env.CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --image "${IMAGE}" \
            --only-show-errors

      - name: Summary
        if: always()
        run: |
          echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** `${{ secrets.ACR_LOGIN_SERVER }}/stakr-backend:latest`" >> $GITHUB_STEP_SUMMARY
